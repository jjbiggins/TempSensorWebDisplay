import ColumnDataset from'./column';import{hasSVG,getMouseCoordinate,pluck,pluckNumber,getValidValue,parseUnsafeString,mathAbs,toRaphaelColor,preDefStr,parseTooltext}from'../lib/lib';import dragColumnAnimation from'../animation-rules/dragcolumn-animation';import{addDep}from'../dependency-manager';let _getJSONData,_restore,UNDEF,SETROLLOVERATTR=preDefStr.setRolloverAttrStr,SETROLLOUTATTR=preDefStr.setRolloutAttrStr,ROLLOUT='DataPlotRollOut',ROLLOVER='DataPlotRollOver',MOUSEOVER='mouseOver',MOUSEOUT='mouseOut',DATAPLOTCLICK=preDefStr.DATAPLOTCLICK,updateDataValue=function(a,b){let c,d=this,e=b.getChildren('yAxis')[0],f=b.getFromEnv('chart-container'),g=d.data('eventArgs');c=getMouseCoordinate(f,a,b),g.value=e.getValue(c.chartY),d.data('eventArgs',g)};addDep({name:'dragColumnAnimation',type:'animationRule',extension:dragColumnAnimation});class DragColumnDataset extends ColumnDataset{getType(){return'dataset'}getName(){return'dragColumn'}configureAttributes(a){var b=this,c=b.config,d=b.getFromEnv('chart-attrib'),e=c.JSONData;c.allowDrag=pluckNumber(e.allowdrag,1),c.allowNegDrag=pluckNumber(e.allownegativedrag,1),c.allowAxisChange=pluckNumber(d.allowaxischange,1),c.snapToDivOnly=pluckNumber(d.snaptodivonly,0),c.snapToDiv=c.snapToDivOnly?1:pluckNumber(d.snaptodiv,1),c.doNotSnap=pluckNumber(d.donotsnap,0),c.snapToDivRelaxation=pluckNumber(d.snaptodivrelaxation,10),c.doNotSnap&&(c.snapToDiv=c.snapToDivOnly=0),super.configureAttributes(a)}_plotConfigure(a,b){let c,d,e=this.config,f=this.components.data;super._plotConfigure(a,b),c=f[a],d=c.config,d.allowDrag=pluckNumber(b.allowdrag,e.allowDrag),d.allowNegDrag=pluckNumber(b.allownegativedrag,e.allowNegDrag)}_firePlotEvent(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=this,t=document,u=s.getFromEnv('chart'),v=s.config,w=v.JSONData,x=u.getFromEnv('dataSource').chart,y=v.currentToolTip,z=s.getFromEnv('chartConfig'),A=z.drawTrendRegion,B=z.useplotgradientcolor,C=z.useroundedges,D=s.getFromEnv('paper'),E=D.canvas,F=E.style,G=s.getFromEnv('number-formatter'),H=s.getFromEnv('toolTipController'),I=s.components.data[b],J=I.config,K=I.graphics.element,L=J.finalTooltext||J.toolText,M=c.originalEvent,N=hasSVG&&'ns-resize'||'n-resize',O=getMouseCoordinate(s.getFromEnv('chart-container'),M),P=O.chartY,Q=I._yPos,R=I._height,S=[1,2,3,4,5,6,7],T=s.getFromEnv('yAxis'),U=T.yBasePos,V=z.yaxisname,W=z.xaxisname,X={xaxisName:W,yaxisName:V},Y=z.canvasTop,Z=z.canvasBottom,$=J.allowDrag,_=J.allowNegDrag,aa=_?Z:U,ba=Q,ca=Q+R;i=z.dragTolerance+1,k=J.setValue,l=Q>=U?Q+R:Q;K&&(f=getValidValue(parseUnsafeString(pluck(w.data[b].tooltext,w.plottooltext,x.plottooltext))),'mouseover'===a?(v.mouseIn=!0,P<=ca-i&&P>=ba+i&&!A&&L&&(y?H.draw(M,L,y):y=v.currentToolTip=H.draw(M,L)),!J._rollOverResponseSetterFire&&P<=ca&&P>=ba&&(DragColumnDataset._rolloverResponseSetter(u,K,c,this),J._rollOverResponseSetterFire=!0)):'mouseout'===a?(v.mouseIn=!1,F.cursor='default',J._rollOverResponseSetterFire&&DragColumnDataset._rolloutResponseSetter(u,K,c,this),J._rollOverResponseSetterFire=!1,H.hide(v.currentToolTip)):'click'===a?J.dragMove||u.plotEventHandler(K,c,DATAPLOTCLICK):'touchmove'===a||'mousemove'===a?J.dragStart||(l=0>J.setValue?Q+R:Q,$&&P>=l-i&&P<=l+i?(F.cursor=N,H.hide(v.currentToolTip)):(F.cursor='default',J._rollOverResponseSetterFire&&!A&&L&&(y?H.draw(M,L,y):y=v.currentToolTip=H.draw(M,L))),!J._rollOverResponseSetterFire&&P<=ca&&P>=ba?(DragColumnDataset._rolloverResponseSetter(u,K,c),J._rollOverResponseSetterFire=!0):J._rollOverResponseSetterFire&&!(P<=ca&&P>=ba)&&(H.hide(v.currentToolTip),J._rollOverResponseSetterFire=!1,DragColumnDataset._rolloutResponseSetter(u,K,c,this))):'touchstart'===a||'mousedown'===a?(d=function(a){P=getMouseCoordinate(s.getFromEnv('chart-container'),a).chartY,a.preventDefault?a.preventDefault():a.returnValue=!1,J._rollOverResponseSetterFire=!1,F.cursor=N,J.dragMove=!0,J._pointerDy++,P+=J._dragBuffer,P<Y?P=Y:P>aa&&(P=aa),Q=U<P?U:P,R=mathAbs(U-P),I._yPos=Q,I._height=R,l=Q>=U?Q+R:Q,J._y=k=J.setValue=T.getValue(l),j=G.dataLabels(k),J.toolTipValue=j,J.displayValue=pluck(J.setDisplayValue,j),B&&!C&&(J.colorArr[0].FCcolor.angle=r=Q<U?90:270),K.attr({y:I._yPos,height:I._height,fill:toRaphaelColor(J.colorArr[0])}),s.parseLabelAttributes(I),s.drawLabel(b,b+1),I.graphics.element=K,H.hide(v.currentToolTip),1===J._pointerDy&&(n={dataIndex:b,datasetIndex:I.datasetIndex,startValue:I.startValue,datasetName:I.name},u.fireChartInstanceEvent('dataplotDragStart',n))},e=function(a){P=getMouseCoordinate(s.getFromEnv('chart-container'),a).chartY,v.mousedown=!1,J.dragStart&&(s.setMaxMin(I),n={dataIndex:b,datasetIndex:I.datasetIndex,startValue:I.startValue,endValue:J.setValue,datasetName:I.name},m=[u.getFromEnv('chartInstance').id,n.dataIndex,n.datasetIndex,n.datasetName,n.startValue,n.endValue],updateDataValue.call(K,a,u),J._pointerDy&&(u.fireChartInstanceEvent('dataplotDragEnd',n),u.fireChartInstanceEvent('chartupdated',n,m)),B&&!C&&(r=Q>=U?90:270,(o=K.data(SETROLLOVERATTR))&&o.fill&&(q=o.fill,q=q.split('-'),q[0]=r,o.fill=q.join('-')),(p=K.data(SETROLLOUTATTR))&&p.fill&&(q=p.fill,q=q.split('-'),q[0]=r,p.fill=q.join('-')))),J._dragBuffer=0,J._pointerDy=0,J.dragStart=!1,f!==UNDEF&&(X.formattedValue=J.toolTipValue,X.label=J.label,L=parseTooltext(f,S,X,{value:J.toolTipValue},UNDEF,w),J.setTooltext=L,f=L,J.toolText=L),L=J.finalTooltext=!1===J.toolText?'':J.toolText+(f?'':J.toolTipValue),P>=l-i&&P<=l+i||(F.cursor='default'),t.removeEventListener?(t.removeEventListener('mousemove',g),t.removeEventListener('mouseup',h),t.removeEventListener('touchmove',g),t.removeEventListener('touchend',h)):(t.detachEvent('onmousemove',g),t.detachEvent('onmouseup',h),t.detachEvent('ontouchmove',g),t.detachEvent('ontouchend',h))},v.mousedown=!0,l=0>J.setValue?Q+R:Q,J.dragMove=!1,$&&P>=l-i&&P<=l+i?(J.dragStart=!0,J._pointerDy=0,J._dragStartY=P,J._dragBuffer=l-P,I.startValue=J.setValue,I.name=v.seriesname,I.datasetIndex=v.index,I.dragged=!0,g=function(a){d(a)},h=function(a){e(a)},t.addEventListener?(t.addEventListener('mousemove',g),t.addEventListener('touchmove',g),t.addEventListener('mouseup',h),t.addEventListener('touchend',h)):(t.attachEvent('onmousemove',g),t.attachEvent('ontouchmove',g),t.attachEvent('onmouseup',h),t.attachEvent('ontouchend',h))):J.dragStart=!1):void 0)}static _rolloverResponseSetter(a,b,c,d){let e=b&&b.getData(),f=a.getFromEnv('animationManager');b&&0!==e.showHoverEffect&&!0!==e.draged&&b&&(f.setAnimationState(MOUSEOVER),f.setAnimation({el:b,label:'rect',component:d,attr:b.getData().setRolloverAttr}),a.plotEventHandler(b,c,ROLLOVER))}static _rolloutResponseSetter(a,b,c,d){let e=b&&b.getData(),f=a.getFromEnv('animationManager');b&&0!==e.showHoverEffect&&!0!==e.draged&&(f.setAnimationState(MOUSEOUT),f.setAnimation({el:b,label:'rect',component:d,attr:b.getData().setRolloutAttr}),a.plotEventHandler(b,c,ROLLOUT))}getJSONData(){var a,b,c,d,e,f=this,g=f.config.JSONData.data,h=f.components.data,j=[],k={};for(e=0,d=g.length;e<d;e++){for(c in b=g[e],a=h[e],k={},b)k[c]='value'===c?a.config.setValue:b[c];j.push(k)}return{data:j}}restore(){var a=this;a.setData(a.config.JSONData,!0)}}_getJSONData=DragColumnDataset.prototype.getJSONData,_restore=DragColumnDataset.prototype.restore;export default DragColumnDataset;export{_getJSONData,_restore,updateDataValue};