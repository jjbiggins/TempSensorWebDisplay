import{UNDEF,pluckNumber,BLANK,pluck}from'../lib/lib';import{triggerEvent}from'./event-api';import{getDepsByType,getDep}from'../dependency-manager';import{priorityList}from'../schedular';import GlobalStore from'./globalstore';let percentRegex=/\%/,globalStore=new GlobalStore,handleContainerResize=function(){var a,b,c={},d=function(){var e,f,g,h,i,j,k,l,m=0,n=parseInt(b.options.resizeTrackingInterval,10)||300,o={},p=function(){o.itemVar._containerOffsetW=o.parentEle.offsetWidth,o.itemVar._containerOffsetH=o.parentEle.offsetHeight};for(e in c)m+=1,f=c[e],g=f.jsVars,i=f.ref,!f.disposed&&(h=i&&i.parentNode)&&(j=i.style)&&(percentRegex.test(j.width)||percentRegex.test(j.height))?(k=h.offsetWidth,l=h.offsetHeight,!g.resizeLocked&&(k&&g._containerOffsetW!==k||l&&g._containerOffsetH!==l)&&(f.resizeTo&&f.resizeTo(),o.itemVar=g,o.parentEle=h,setTimeout(p,1))):(delete c[e],m-=1);a=m?setTimeout(d,n):clearTimeout(a)};return function(e,f,g){var h=e.jsVars,i=f||e.ref&&e.ref.parentNode||{};b=g,h._containerOffsetW=i.parentNode.offsetWidth,h._containerOffsetH=i.parentNode.offsetHeight,c[e.id]=e,a||(a=setTimeout(d,parseInt(g.options.resizeTrackingInterval,10)||300))}}();function createChart(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s=b.jsVars,t=b.apiInstance,u=s.hasNativeMessage,v=b.options,w=b.args,x=s.secondTimeRender,y=percentRegex.test(b.width)?c.offsetWidth:b.width,z=percentRegex.test(b.height)?c.offsetHeight:b.height,A=function(){t.setChartEvents(),o({hasRendered:!0,container:c})},B=()=>{let a=h.error instanceof Error;return a&&(b._chartMessageImageStyle={imageHAlign:pluck(w.dataInvalidMessageImageHAlign,v.baseChartMessageImageHAlign).toLowerCase(),imageVAlign:pluck(w.dataInvalidMessageImageVAlign,v.baseChartMessageImageVAlign).toLowerCase(),imageAlpha:pluckNumber(w.dataInvalidMessageImageAlpha,v.baseChartMessageImageAlpha),imageScale:pluckNumber(w.dataInvalidMessageImageScale,v.baseChartMessageImageScale)},b._chartMessageStyle={fontFamily:w.dataInvalidMessageFont||v.baseChartMessageFont,fontSize:w.dataInvalidMessageFontSize||v.baseChartMessageFontSize,color:w.dataInvalidMessageColor||v.baseChartMessageColor},t.createBaseComponent(),t.getFromEnv('animationManager').setAnimationState('chartmessage'),t.setChartMessage(v.dataInvalidMessage,b,c),t.drawChartMessage(),t.getContainer('parentgroup')&&t.getContainer('parentgroup').hide(),u=s.hasNativeMessage=!0,b.__state.dataReady=!1,!g&&triggerEvent('dataInvalid',s.fcObj,{error:h.error},UNDEF,function(){triggerEvent('dataxmlinvalid',b,{},[b.id])})),a};if(d=d||b.chartType(),j=getDep(d,'chartapi'),!j&&(p=getDep(d,'maps'))&&(j=getDep('maps','chartapi'),r=!0),t&&(t.addToEnv('chartWidth',y),t.addToEnv('chartHeight',z)),c.FusionCharts=a.items[b.id],w.asyncRender=pluckNumber(w.asyncRender,1),o=function(d){if(!b.disposed){var f={renderer:'javascript'},i=s.fcObj,j=i.width,k=i.height,h=s.overlayButton;if(u=s.hasNativeMessage,s.container=c,s.hcObj=d,s.width=t.getFromEnv('chartWidth'),s.height=t.getFromEnv('chartHeight'),s.instanceAPI=t,d.hasRendered&&s.overlayButtonActive&&h&&(h.innerHTML=BLANK,h.appendChild(document.createTextNode(s.overlayButtonMessage)),d.container.appendChild(h)),(/\%/g.test(j)||/\%/g.test(k))&&c&&c.parentNode&&!a.options.preventTrackResize&&handleContainerResize(i,c,a),e&&(e({success:d.hasRendered,ref:c,id:b.id}),d.hasRendered&&!b.disposed)){if(t.config.hasRendered=!0,!0===b.disposed)return;u||(i.__state.firstRenderNotified=!0,t.addJob('postFirstRender-fire-rendered',function(){triggerEvent('rendered',i,{renderer:'javascript'},[i.id])},priorityList.postRender))}!b.disposed&&d.hasRendered&&s.previousDrawCount<s.drawCount&&(f.width=s.width,f.height=s.height,f.drawCount=s.drawCount,f.displayingMessage=u,f.renderer=i.options.renderer,triggerEvent('drawcomplete',i,f,[i.id]),!b.disposed&&!u&&!g&&t.addJob('postSecondRender-fire-rendered',function(){i.__state&&!i.__state.firstRenderNotified&&triggerEvent('rendered',i,{renderer:'javascript'},[i.id]),triggerEvent('renderComplete',i,f)},priorityList.postRender))}},t&&t.getState('initiated')){if(triggerEvent('internal.drawStart',b,{chartType:d,logicName:t.name,logicBase:t.base&&t.base.name,defaultSeriesType:t.defaultSeriesType}),!b.disposed){if(t.getState('stallLoad')?(t.setState('stallLoad',!1),t.setState('state','initial')):t.setState('state','update'),h=b.jsVars&&b.jsVars.themeObject&&b.jsVars.themeObject.getThemedJSONData()||b.getChartData(getDepsByType('transcoder').JSON,!0,!0),i=h.data,t.addToEnv('dataSource',i),t.addToEnv('chart-attrib',i.chart),B())return;if(t._checkInvalidData()||t._checkInvalidSpecificData())return t.createBaseComponent(),t.getFromEnv('animationManager').setAnimationState('chartmessage'),t.setChartMessage(),t.drawChartMessage(),triggerEvent('nodatatodisplay',b,{},[b.id]),void(b.disposed||(o&&o({hasRendered:!0,container:c}),t.getContainer('parentgroup')&&t.getContainer('parentgroup').hide()));t.config.hasChartMessage=!1,g||triggerEvent('dataloaded',b,{},[b.id]),b.disposed||(t._removeWaitingJobs(),t.addToEnv('chartWidth',y),t.addToEnv('chartHeight',z),t.setData(i),!b.hasRendered()&&t.getFromEnv('paper')&&t.setChartEvents(),o({hasRendered:!0,container:c}))}}else if(t&&'base'===d)t.createBaseComponent(),t.getFromEnv('animationManager').setAnimationState('chartmessage'),t.setChartMessage(f,b,c),t.drawChartMessage(),e({success:!0,ref:c,id:b.id});else{if(t&&'base'===t.getName()&&'base'!==d&&(t.remove({instant:!0}),t=UNDEF),!t){if(t=b.apiInstance=new j,globalStore.attachChild(t,'chartAPI'),t.addToEnv('chartInstance',b),t.addToEnv('chart',t),t.addToEnv('chart-container',c),t.addToEnv('chartWidth',y),t.addToEnv('chartHeight',z),t.addToEnv('eventListeners',[]),r)for(q in p=p[0],p)p.hasOwnProperty(q)&&(t.config[q]=p[q]);'base'!==d&&(m=getDep('ToolTipController'),n=new m(c),t.addToEnv('toolTipController',n),t.disposeChartStyleSheet(),t.addEventListener('postconfigure',function(a){t.addJob('postConfigure-lagacy-fn',A,priorityList.postRender),a.detachHandler()}),t.setState('initiated',!0),b.__state.dataReady=!0),t.addToEnv('core-options',a.options)}if(t.config.origRenderWidth=b.__state.renderedWidth,t.config.origRenderHeight=b.__state.renderedHeight,'base'!==d){if(c.jsVars=b.jsVars,k=t.eiMethods,b.ref=c,s.type=d,k&&'string'!=typeof k)for(l in k)c[l]=k[l];triggerEvent('loaded',b,{type:d,renderer:'javascript'},[b.id])}if(!b.disposed)if('base'===d)t.setDummyEImethods(b.chartType()),t.createBaseComponent(),t.getFromEnv('animationManager').setAnimationState('chartmessage'),t.setChartMessage(f,b,c),t.drawChartMessage();else if(f!==UNDEF)'string'==typeof f&&(t.setChartMessage(f,b,c),t.drawChartMessage(),u=s.hasNativeMessage=!0);else if(!(t&&t.configure)||t&&'base'===t.name)b._chartMessageImageStyle={imageHAlign:pluck(w.typeNotSupportedMessageImageHAlign,v.baseChartMessageImageHAlign).toLowerCase(),imageVAlign:pluck(w.typeNotSupportedMessageImageVAlign,v.baseChartMessageImageVAlign).toLowerCase(),imageAlpha:pluckNumber(w.typeNotSupportedMessageImageAlpha,v.baseChartMessageImageAlpha),imageScale:pluckNumber(w.typeNotSupportedMessageImageScale,v.baseChartMessageImageScale)},b._chartMessageStyle={color:w.typeNotSupportedMessageColor||v.baseChartMessageColor,fontFamily:w.typeNotSupportedMessageFont||v.baseChartMessageFont,fontSize:w.typeNotSupportedMessageFontSize||v.baseChartMessageFontSize},t.setChartMessage(v.typeNotSupportedMessage,b,c),t.drawChartMessage(),u=s.hasNativeMessage=!0;else if(s.message)t.setChartMessage(s.message,b,c),t.drawChartMessage(),u=s.hasNativeMessage=!0;else if(s.loadError)b._chartMessageImageStyle={imageHAlign:pluck(w.dataLoadErrorMessageImageHAlign,v.baseChartMessageImageHAlign).toLowerCase(),imageVAlign:pluck(w.dataLoadErrorMessageImageVAlign,v.baseChartMessageImageVAlign).toLowerCase(),imageAlpha:pluckNumber(w.dataLoadErrorMessageImageAlpha,v.baseChartMessageImageAlpha),imageScale:pluckNumber(w.dataLoadErrorMessageImageScale,v.baseChartMessageImageScale)},b._chartMessageStyle={color:w.dataLoadErrorMessageColor||v.baseChartMessageColor,fontFamily:w.dataLoadErrorMessageFont||v.baseChartMessageFont,fontSize:w.dataLoadErrorMessageFontSize||v.baseChartMessageFontSize},t.createBaseComponent(),t.getFromEnv('animationManager').setAnimationState('chartmessage'),t.setChartMessage(v.dataLoadErrorMessage,b,c),t.drawChartMessage(),u=s.hasNativeMessage=!0;else if(s.stallLoad)t.setState('stallLoad',!0),b._chartMessageImageStyle={imageHAlign:pluck(w.dataLoadStartMessageImageHAlign,v.baseChartMessageImageHAlign).toLowerCase(),imageVAlign:pluck(w.dataLoadStartMessageImageVAlign,v.baseChartMessageImageVAlign).toLowerCase(),imageAlpha:pluckNumber(w.dataLoadStartMessageImageAlpha,v.baseChartMessageImageAlpha),imageScale:pluckNumber(w.dataLoadStartMessageImageScale,v.baseChartMessageImageScale)},b._chartMessageStyle={fontFamily:w.dataLoadStartMessageFont||v.baseChartMessageFont,fontSize:w.dataLoadStartMessageFontSize||v.baseChartMessageFontSize,color:w.dataLoadStartMessageColor||v.baseChartMessageColor},t.createBaseComponent(),t.getFromEnv('animationManager').setAnimationState('chartmessage'),t.setChartMessage(v.dataLoadStartMessage,b,c),t.drawChartMessage(),u=s.hasNativeMessage=!0,o({hasRendered:!0,container:c});else if('zoomscatter'===d&&!document.createElement('canvas').getContext)b._chartMessageImageStyle={imageHAlign:pluck(w.browserNotSupportedMessageImageHAlign,v.baseChartMessageImageHAlign).toLowerCase(),imageVAlign:pluck(w.browserNotSupportedMessageImageVAlign,v.baseChartMessageImageVAlign).toLowerCase(),imageAlpha:pluckNumber(w.browserNotSupportedMessageImageAlpha,v.baseChartMessageImageAlpha),imageScale:pluckNumber(w.browserNotSupportedMessageImageScale,v.baseChartMessageImageScale)},b._chartMessageStyle={color:w.browserNotSupportedMessageColor||v.baseChartMessageColor,fontFamily:w.browserNotSupportedMessageFont||v.baseChartMessageFont,fontSize:w.browserNotSupportedMessageFontSize||v.baseChartMessageFontSize},t.createBaseComponent(),t.getFromEnv('animationManager').setAnimationState('chartmessage'),t.setChartMessage(pluck(w.browserNotSupportedMessage,v.browserNotSupportedMessage),b,c),t.drawChartMessage(),u=s.hasNativeMessage=!0;else if(triggerEvent('internal.drawStart',b,{chartType:d,logicName:t.name,logicBase:t.base&&t.base.name,defaultSeriesType:t.defaultSeriesType}),!b.disposed&&(h=b.jsVars&&b.jsVars.themeObject&&b.jsVars.themeObject.getThemedJSONData()||b.getChartData(getDepsByType('transcoder').JSON,!0),i=h.data,t.setState('state','initial'),!B()&&(g||triggerEvent('dataloaded',b,{},[b.id]),!b.disposed))){if(!0===t.getFromEnv('chartInstance').disposed)return;if(w.asyncRender&&!x&&'base'!==d&&(t.createBaseComponent(),t.getFromEnv('animationManager').setAnimationState('chartmessage'),t.setChartMessage(t.getFromEnv('chartInstance').options.loadMessage,UNDEF,c),t.drawChartMessage(),t.config.hasChartMessage=!1),t.addToEnv('dataSource',i),t.addToEnv('chart-attrib',i.chart),t._checkInvalidData()||t._checkInvalidSpecificData())return t.createBaseComponent(),t.getFromEnv('animationManager').setAnimationState('chartmessage'),t.setChartMessage(),t.drawChartMessage(),triggerEvent('nodatatodisplay',b,{},[b.id]),void(o&&o({hasRendered:!0,container:c}));t.config.hasChartMessage=!1,t.setData(i)}}s.secondTimeRender=!0}export{globalStore};export default createChart;