import ComponentInterface from'../../core/component-interface';import{getDepsByType}from'../../_internal/dependency-manager';import{raiseWarning}from'../../_internal/misc/event-api';let UNDEF,themer,BLANK='',OBJECTSTRING='object',arrayToStr='[object Array]',objectToStr='[object Object]',isImportantRegEx=/\s+!important$/,importantStrRegEx=/\\!important$/,getValueFromObjProperty=function(a,b){var c,d;for(d in b=(b+'').toLowerCase(),a)if(a.hasOwnProperty(d)&&b===(d+'').toLowerCase()){c=a[d];break}return c},trimString=function(a){a=a.replace(/^\s\s*/,'');for(var b=/\s/,c=a.length;b.test(a.charAt(c-=1)););return a.slice(0,c+1)},getRegisteredThemes=a=>{let b,c={};for(var d in a)a.hasOwnProperty(d)&&(b=a[d],c[b.name]=b);return c},checkCyclicRef=function(a,b){for(var c=b.length,d=-1;c--;)if(a===b[c])return d=c,d;return d},merge=function(a,b,c,d,e){var f,g,h,i,j;if(e?(d.push(a),e.push(b)):(d=[a],e=[b]),b instanceof Array)for(f=0;f<b.length;f+=1){try{g=a[f],h=b[f]}catch(a){continue}typeof h==OBJECTSTRING?((null===g||typeof g!=OBJECTSTRING)&&(g=a[f]=h instanceof Array?[]:{}),j=checkCyclicRef(h,e),-1===j?merge(g,h,c,d,e):g=a[f]=d[j]):!(c&&h===UNDEF)&&(a[f]=h)}else for(f in b){try{g=a[f],h=b[f]}catch(a){continue}null!==h&&typeof h==OBJECTSTRING?(i=Object.prototype.toString.call(h),i===objectToStr?((null===g||typeof g!=OBJECTSTRING)&&(g=a[f]={}),j=checkCyclicRef(h,e),-1===j?merge(g,h,c,d,e):g=a[f]=d[j]):i===arrayToStr?((null===g||!(g instanceof Array))&&(g=a[f]=[]),j=checkCyclicRef(h,e),-1===j?merge(g,h,c,d,e):g=a[f]=d[j]):a[f]=h):a[f]=h}return a},extend2=function(a,b,c){return typeof a!=OBJECTSTRING&&typeof b!=OBJECTSTRING?null:typeof b!=OBJECTSTRING||null===b?a:(typeof a!=OBJECTSTRING&&(a=b instanceof Array?[]:{}),merge(a,b,c),a)},checkImportance=function(a){var b={important:!1,str:BLANK};return a?(a=a.toString(),isImportantRegEx.test(a)?(a=a.replace(isImportantRegEx,BLANK),b.important=!0):(a=a.replace(importantStrRegEx,'!imporant'),b.important=!1),b.str=a,b):b},mergeThemeWithData=function(a,b){var c,d,e,f=b.getAll();for(c in f)d=f[c].toString(),e=checkImportance(d),e.important?a[c.toLowerCase()]=e.str:a[c.toLowerCase()]===UNDEF&&(a[c.toLowerCase()]=e.str)},onChartTypeChange=function(a,b){var c,d=a.sender,e=d.getChartData();e.error||(c=e&&(e.chart&&e.chart.theme||e.map&&e.map.theme),c?(e.map&&(e.chart=e.map,delete e.map),themer.themify(c,d,d.chartType(),e,'geo'===b.defaultSeriesType&&'geo')):d.jsVars&&d.jsVars.themeObject&&d.jsVars.themeObject.dispose())},recursiveApply=function(a,b){var c,d,e,f,g,h,j=0,k=0;for(c in a)if(d=a[c],d instanceof Array)for(h=d.length,g=0;g<h;g+=1)f=d[g],'object'==typeof f&&('category'===c?'true'===f.vline?(e=b.component('vline',j,f),e&&(mergeThemeWithData(f,e),j+=1)):(e=b.component('category',k,f,h),e&&(mergeThemeWithData(f,e),k+=1)):(e=b.component(c,g,f,h),e&&(mergeThemeWithData(f,e),recursiveApply(f,e))));else'object'==typeof d&&(e=b.component(c,null,d),e&&(mergeThemeWithData(d,e),recursiveApply(d,e)))};class ThemeManager extends ComponentInterface{configure(){this.config.themeStore||(this.config.themeStore={})}add(a){for(var b,c=this,d=0,e=a.length;d<e;d+=1)b=a[d].name,b&&(c.config.themeStore[b]=a[d])}themify(a,b,c,d,e){var f,g,h=this,j=b.jsVars,k=a.split(','),l=[],m=k.length;if(h.config.themeStore=getRegisteredThemes(getDepsByType('theme')),m){for(g=0;g<m;g+=1)f=h.config.themeStore[trimString(k[g])],f&&l.push(ThemeManager.evaluateThemeJSON(f.theme,b,c,e));l.length?(j.themeObject=new ThemeInstance(l,b,!1,d),ThemeManager.applyTheme(b),!h._attachedListeners&&(b.addEventListener('chartTypeChanged',onChartTypeChange),h._attachedListeners=!0)):raiseWarning(b,'14051100501','run','api.themes~themify()','The theme "'+a+'" requested has not been registered.')}}static evaluateThemeJSON(a,b,c,d){var e,f,g={},h=b.jsVars,i=function(a){var b,c;for(b in a)c=a[b],g[b]=c instanceof Array?extend2(g[b]||[],c):'object'==typeof c?extend2(g[b]||{},c):c};return c=c||b.chartType(),h.themeObject&&a!==h.themeObject&&(h.themeObject.dispose(),delete h.themeObject),i(getValueFromObjProperty(a,'base')),d&&(e=getValueFromObjProperty(a,d)),e&&i(e),c&&(f=getValueFromObjProperty(a,c)),f&&i(f),g}static applyTheme(a){var b=a.jsVars.themeObject,c=b.getThemedJSONData().data;c&&recursiveApply(c,b)}}class ThemeInstance extends ComponentInterface{constructor(a,b,c,d){super();var e,f=0;for(this.themeArray=a,this.themeComponents={},this.base={},this.chartInstance=b,this.isChildInstance=!!c,this.themedData=c?null:extend2({},d),this.length=a.length,e=a.length;f<e;f+=1)this.parse(a[f])}pushTheme(a){a&&(this.themeArray.push(a),this.parse(a),this.length+=1)}parse(a){var b,c,d,e,f,g=this,h=g.themeComponents,i=g.chartInstance,j=g.base;for(c in f=a,f)'string'==typeof f[c]||'number'==typeof f[c]?j[c]?(d=checkImportance(f[c]),e=checkImportance(j[c]),(d.important||!e.important)&&(j[c]=f[c])):j[c]=f[c]:(h[c]||(h[c]=[]),b=h[c],f[c]instanceof Array?b.push(extend2([],f[c])):'object'==typeof f[c]?b.push(new ThemeInstance([f[c]],i,!0)):'function'==typeof f[c]&&b.push(f[c]))}merge(a){var b,c,d,e=this,f=e.base,g=a.base,h=e.themeComponents,i=a.themeComponents;for(d in g)b=checkImportance(f[d]),c=checkImportance(g[d]),(!b.important||c.important)&&(f[d]=g[d]);for(d in i)h[d]=h[d]?h[d].concat(i[d]):[].concat(i[d]);e.length+=a.length}get(a){return this.base[a]}getAll(){return extend2({},this.base)}component(a,b,c,d){var e,f,g,h,j,k,l=this,m=l.themeComponents,n=l.chartInstance,o=new ThemeInstance([],n,!0);if(j=m[a],!j)return null;for(f=0,g=j.length;f<g;f+=1)k=j[f],'function'==typeof k?(b=b||0,o.pushTheme(k.call(n,b,c,d))):k instanceof Array?(b=b||0,h=k.length,b%=h,e=k[b],e instanceof ThemeInstance?o.merge(e):'function'==typeof e?o.pushTheme(e.call(n,b,c,d)):o.pushTheme(e)):k instanceof ThemeInstance?o.merge(k):o.pushTheme(k);return o}getThemedJSONData(){return{data:this.themedData}}dispose(){var a,b,c=this,d=c.themeComponents,e=c.chartInstance;for(a in d)if(b=d[a].length,b){for(;b--;)d[a][b].dispose&&d[a][b].dispose();delete d[a]}c.isChildInstance||e.removeEventListener('chartTypeChanged',onChartTypeChange),c.themeComponents=null,c.chartInstance=null,c.base=null,c.themeArray=null,c.isChildInstance=null,c.dataWithoutTheme=null}}themer=new ThemeManager,themer.configure();function FCPlugger(a){a.addEventListener('internal.drawStart',function(b,c){var d,e,f,g=b.sender,h=getRegisteredThemes(getDepsByType('theme')),j=g.getChartData(),k=a.options.defaultTheme,l=j&&(j.chart&&j.chart.theme||j.map&&j.map.theme),m=(k||l)&&`${k||''},${l||''}`,n=m&&m.split(','),o=n&&n.length,p=!1;for(e=0;e<o;e++)f=trimString(n[e]),h&&''!==f&&h.hasOwnProperty(f)&&(p=!0);p?(d=g.chartType(),j.map&&(j.chart=j.map,delete j.map),themer.themify(m,g,d,j,'geo'===c.defaultSeriesType&&'geo')):g.jsVars&&g.jsVars.themeObject&&(g.jsVars&&g.jsVars.themeObject.dispose(),g.jsVars&&delete g.jsVars.themeObject)})}export default{extension:FCPlugger,name:'ThemeEngine',type:'extension',requiresFusionCharts:!0};