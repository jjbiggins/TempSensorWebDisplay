import Base from'./input-base';import{getMouseCoordinate}from'../../_internal/lib/lib';var getTouchDistance=function(a,b,c){var d=c?'pageY':'pageX';return b[d]-a[d]},correctZoomRatio=function(a){return 0>a?-a:a},max=Math.max,min=Math.min,getZoomRange=function(a,b,c,d,e){var f=Math.round,g=a.getVisibleConfig(),h=a.getValue(b[d?'y':'x']+a.getTranslation()),i=h-g.minValue,j=g.maxValue-h,k=a.config.axisRange;return{min:f(max(k.min,h-i/c)*e)/e,max:f(min(k.max,h+j/c)*e)/e}};class InputPinchZoom extends Base{constructor(){super();var a=this;a.controlArr=[{nativeInteraction:['touchend'],callback:a.touchend.bind(a),component:a},{nativeInteraction:['touchstart','touchmove'],callback:a.touch.bind(a),component:a}]}getName(){return'pinchZoom'}configure(){super.configure(),this.enable()}getCenter(a,b){var c=this.getFromEnv('chart'),d=getMouseCoordinate(c.getLinkedItem('container'),{pageX:(a.pageX+b.pageX)/2,pageY:(a.pageY+b.pageY)/2},c);return{x:d.chartX,y:d.chartY}}drag(a){var b,c,d,e,f,g,h,i,j,k,l,m=this,n=a.touches[0],o=a.touches[1],p=m.config,q=p.touchConfig,r={},s=!1,t={},u=m.getFromEnv('chart'),v=m.getFromEnv('axesObArr'),w=Math.pow(10,p.zoomDecimalLimit)||1,x=u.getChildContainer().plotGroup;q?(b=getTouchDistance(n,o),c=getTouchDistance(n,o,!0),d=correctZoomRatio(b/q.distanceX),e=correctZoomRatio(c/q.distanceY),v.forEach(function(){x.transform(''),x.scale(d,e,q.center.x,q.center.y)}),clearTimeout(p.chartDraw),p.chartDraw=setTimeout(function(){x.transform(''),v.forEach(function(a){var b=a.axis,c=getZoomRange(b,q.center,a.isY?e:d,a.isY,w),f=c.min,n=c.max,o=a.stack,p=b.getVisibleConfig(),u=b.getLimit(),v=o.length-1,x=o[v],y=Math.floor(f)===u.min&&Math.ceil(n)===u.max,z=b.getZoom()>=w;if(!x)y||z||(o.push(p),r.zoomin=!0);else if(y)a.stack=[],r.zoomout=!0;else if(x.minValue>f&&x.maxValue<n){for(;x&&x.minValue>f&&x.maxValue<n;)o.pop(),x=o[--v];r.zoomout=!0}else z||(o.push(p),r.zoomin=!0);a.isY?(j=f,k=n):(h=f,i=n,t=m.constructor._getZoomInfo(h,i,b)),l=a.stack.length+1,g=b.setVisibleConfig(f,n),s=s||g}),m.touchend(),s&&(r.zoomout&&m._raiseZoomEvents('zoomout','zoomedout',Object.assign(t,{level:l,startX:h,endX:i,startY:j,endY:k})),r.zoomin&&m._raiseZoomEvents('zoomin','zoomedin',Object.assign(t,{level:l,startX:h,endX:i,startY:j,endY:k}))),p.chartDraw=null},250)):(q=p.touchConfig={finger0:n,finger1:o,center:this.getCenter(n,o),distanceX:getTouchDistance(n,o),distanceY:getTouchDistance(n,o,!0)},v.forEach(function(a){f=a.axis,a.visibleConfig=f.getVisibleConfig(),a.centerVal=f.getValue(a.isY?q.center.y:q.center.x)}))}touch(a){var b=this;this.getFromEnv('animationManager').setAnimationState('touch'),2===a.originalEvent.touches.length?(b.drag(a.originalEvent),a&&a.preventDefault()):b.touchend()}touchend(){this.config.touchConfig=null}setControl(){var a=this,b=a.getLinkedParent(),c=a.controlArr;b.releaseControl(c),a.isEnabled()&&b.getControl(c)}}export default InputPinchZoom;